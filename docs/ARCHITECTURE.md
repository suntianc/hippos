# Hippos 架构设计

> 架构设计概述，详细内容请参考 [架构设计文档](./架构设计文档.md)

## 一、架构原则

### 1.1 性能优先
- P99 延迟 < 10ms
- 核心路径零阻塞
- 异步 I/O 优先

### 1.2 多租户隔离
- 存储层隔离
- 索引层隔离
- 检索层隔离

### 1.3 渐进式复杂度
- 先简单后复杂
- 清晰演进边界
- 零停机升级

### 1.4 协议兼容
- MCP 协议规范
- RESTful API
- gRPC 接口

## 二、分层架构

```
接入层 → 服务层 → 索引层 → 存储层
```

### 2.1 接入层
- **MCP Server**：核心接入方式，对接 AI Agent
- **REST API**：管理操作和调试
- **gRPC**：高性能场景

### 2.2 服务层
- **SessionManager**：会话生命周期管理
- **RetrievalSvc**：检索引擎服务
- **IndexSvc**：索引管理服务
- **DehydrationSvc**：脱水处理服务
- **AuthSvc**：权限校验服务

### 2.3 索引层
- **Vector Index**：IVF-PQ 算法，384 维向量
- **Full-Text Index**：中文分词，支持语义扩展
- **Inverted Index**：主题标签和关键词映射

### 2.4 存储层
- **SurrealDB**：主存储，多模态数据库
- **LanceDB**：向量索引，高性能检索

## 三、核心模块

### 3.1 存储层设计

#### 会话隔离机制（三层）
1. **Namespace 隔离**：SurrealDB Namespace 级别
2. **表级隔离**：表名包含会话标识前缀
3. **字段级隔离**：记录级别所有者标识

#### 数据模型
- **Session**：会话元数据
- **Turn**：对话轮次（核心实体）
- **IndexRecord**：索引记录（轻量级）

### 3.2 索引引擎设计

#### 动态索引架构
- 倒排索引层：主题标签、时间范围
- 向量索引层：IVF-PQ 算法
- 全文索引层：中文分词

#### 渐进式披露
- **感知阶段**：仅返回摘要索引
- **挂载阶段**：返回完整内容

### 3.3 检索引擎设计

#### 双阶段检索
1. **索引检索**：快速筛选候选记录
2. **内容获取**：按需获取详细内容

#### 混合检索策略
- 时间加权检索
- 向量相似度检索
- Reciprocal Rank Fusion 融合

### 3.4 API 层设计

#### MCP 工具定义
- `list_recent_indices`：列出最近索引
- `search_indices`：搜索索引
- `fetch_turn_content`：获取完整内容
- `store_turn`：存储对话轮次

#### REST API
```
POST   /api/v1/sessions
GET    /api/v1/sessions/{id}
DELETE /api/v1/sessions/{id}

POST   /api/v1/sessions/{id}/turns
GET    /api/v1/sessions/{id}/turns
GET    /api/v1/sessions/{id}/turns/{tid}

GET    /api/v1/sessions/{id}/indices
GET    /api/v1/sessions/{id}/search

GET    /health
GET    /metrics
```

## 四、数据流设计

### 4.1 写入数据流
1. 请求接收 → 格式验证
2. 会话校验
3. 异步入队
4. 生成摘要
5. 生成向量
6. 更新索引
7. 持久化存储

### 4.2 读取数据流
1. 请求接收
2. 权限校验
3. L1 缓存查询
4. 索引检索
5. 权限校验
6. 返回结果

## 五、性能设计

### 5.1 延迟优化
- 零阻塞设计
- SIMD 向量化
- 连接池优化

### 5.2 高并发隔离
- 会话级资源隔离
- 向量空间隔离

### 5.3 基准测试目标

#### 吞吐量
| 场景 | QPS |
|------|-----|
| 索引列表查询 | ≥ 50,000 |
| 向量语义检索 | ≥ 5,000 |
| 全文关键词检索 | ≥ 10,000 |
| 混合检索 | ≥ 3,000 |
| 内容获取 | ≥ 20,000 |
| 新对话写入 | ≥ 10,000 |

#### 容量
| 指标 | 目标 |
|------|------|
| 单节点活跃会话 | ≥ 10,000 |
| 单会话最大轮次 | 1,000,000 |
| 向量索引总规模 | ≤ 100,000,000 |

#### 延迟
| 百分位 | 延迟 |
|--------|------|
| P50 | ≤ 2ms |
| P90 | ≤ 5ms |
| P99 | ≤ 10ms |
| P99.9 | ≤ 50ms |

## 六、安全设计

### 6.1 数据隔离
- 3-Tier 隔离（Namespace → Table → Field）
- 严格的权限校验

### 6.2 传输安全
- TLS 1.3 加密
- AES-256-GCM 数据加密

### 6.3 访问控制
- Rate Limiting（滑动窗口）
- DDoS 防护
- 审计日志

## 七、监控运维

### 7.1 指标监控
- Prometheus 指标
- 关键性能指标

### 7.2 日志系统
- 结构化日志（JSON）
- 日志级别策略

### 7.3 告警规则
- 延迟告警
- 错误率告警
- 资源使用告警

### 7.4 可视化
- Grafana 仪表板
- 关键指标展示

## 八、容灾备份

### 8.1 备份策略
- 连续数据保护（CDP）
- 多区域副本

### 8.2 恢复目标
- RPO：< 5 分钟
- RTO：< 30 分钟

## 九、成本控制

### 9.1 分层存储
- Hot（热数据）：SSD，高性能
- Warm：HDD，容量存储
- Cold：归档存储
- Archive：长期归档

### 9.2 自动归档
- 基于访问频率
- 基于数据年龄

---

## 相关文档

- [详细架构设计文档](./架构设计文档.md)
- [需求文档](./需求文档.md)
- [评审建议](./评审建议.md)
