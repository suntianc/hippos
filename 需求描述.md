# 个人 Agent 记忆系统 —— 完整需求描述（可拆解版）

> 本文档描述一个**个人 Agent 的长期记忆系统**，用于支持 Agent 在长期交互中保持一致性、可解释性与可纠错性。
> 本系统以 **LLM 只做判断与提议，系统负责裁决与执行** 为核心设计原则。
> **这个记忆系统的目的，不是让 Agent“记住一切”，
> 而是让它在长期陪伴中，
> 既不健忘，也不自作主张。**
---

## 1. 目标与边界

### 1.1 核心目标

构建一个记忆系统，使个人 Agent 能够：

1. **在回答和决策时有依据**（不胡编、不前后矛盾）
2. **在长期交互中保持一致，但不僵化**
3. **能解释“为什么这么说”，而不是只给结果**
4. **允许用户纠错、修改、遗忘**

---

### 1.2 非目标（明确不做的事）

* ❌ 不追求“人格模拟”或“心理画像”
* ❌ 不自动把所有对话内容当成事实
* ❌ 不让 LLM 直接操作数据库
* ❌ 不做企业级合规/审批系统

---

## 2. 记忆系统的基本假设（非常重要）

1. **所有输入首先都是“事件”，不是事实**
2. **记忆是分级的，不是写 / 不写二元选择**
3. **同一信息可被投影到不同记忆层，身份不同**
4. **历史记忆只能作为参考与约束，不能主导决策**

---

## 3. 记忆系统的三大组成（职责边界）

### 3.1 数据库（事实记忆 / Truth Memory）

**职责**

> 存储 Agent 在回答中愿意“对外负责”的结论性事实。

**特征**

* 可覆盖、可修正
* 有适用范围（场景/时间）
* 有版本与来源
* 明确区分“候选事实 / 已确认事实”

**典型内容**

* 用户明确确认的偏好
* 长期目标
* 当前状态（进行中/已完成）

---

### 3.2 向量库（线索记忆 / Recall Memory）

**职责**

> 存储用于“想起相关经历”的语义线索。

**特征**

* 不保证正确
* 不参与裁决
* 可衰减、可过期
* 默认低风险、低门槛

**典型内容**

* 历史对话片段
* 方案讨论过程
* 一次性经历

---

### 3.3 图数据库（关系记忆 / Structural Memory）

**职责**

> 存储事实之间的**结构关系与适用约束**，用于保证回答“说得通”。

**特征**

* 不存孤立事实
* 不直接给结论
* 表达关系、依赖、冲突、上下文

**典型内容**

* 用户 ↔ 场景 ↔ 偏好
* 目标 ↔ 子目标 ↔ 约束
* 概念之间的包含 / 排斥关系

---

## 4. LLM 的角色与职责

### 4.1 主 LLM（对话 / 决策）

**职责**

* 理解当前问题
* 决定是否需要参考历史记忆
* 在约束条件下生成回答或决策

**明确不做**

* ❌ 不直接写记忆
* ❌ 不裁决是否升格为事实

---

### 4.2 记忆 LLM（整理 / 提议）

> 可以是同一个模型的不同调用，也可以是更小的模型

**职责**

* 将对话内容转化为“事件描述”
* 判断是否具备：

  * 事实候选价值
  * 回忆价值
  * 结构关系价值
* 输出**结构化记忆提议**

**输出的是：提议，而不是执行命令**

---

## 5. 系统裁决机制（个人 Agent 版）

### 5.1 裁决目标

系统裁决的核心问题不是“对不对”，而是：

> **这条信息现在配不配被当成“用户的一部分”？**

---

### 5.2 裁决依据（从强到弱）

1. **用户确认信号**

   * 明确授权（“你记住这个”）
   * 明确指令（“以后就这样”）

2. **稳定性信号**

   * 是否像长期不变的东西
   * 是否明显是情绪/临时想法

3. **重复与一致性**

   * 是否在不同时间重复出现
   * 是否存在冲突表达

4. **影响半径**

   * 记错的代价大小

---

### 5.3 裁决结果不是“写 / 不写”，而是：

* 仅记录为事件
* 记录为线索（向量）
* 记录为候选事实（有 TTL）
* 升格为事实
* 写入关系但限定场景

---

## 6. 决策与记忆的完整流程（端到端）

### 6.1 当前请求处理路径

1. 接收用户输入 → 事件
2. 主 LLM 判断是否需要历史记忆
3. 系统按需读取：

   * 事实（数据库）
   * 线索（向量库）
   * 结构（图数据库）
4. 主 LLM 在约束下生成回答
5. 输出给用户

---

### 6.2 事后记忆处理路径（异步）

1. 记忆 LLM 分析本轮对话
2. 生成结构化“记忆提议”
3. 系统裁决：

   * 是否升格
   * 升格到哪一层
   * 权重 / TTL / 适用范围
4. 系统执行写入或降级

---

## 7. 系统接口能力（概念级）

### 7.1 记忆读取接口

* 读取事实（带版本/范围）
* 召回线索（Top-K）
* 查询关系结构（单跳 / 多跳）

---

### 7.2 记忆写入接口（分层）

* 事件追加
* 事实升格提议
* 关系升格提议
* 线索索引

---

### 7.3 记忆治理接口

* 覆盖 / 更新
* 降级 / 过期
* 遗忘 / 删除
* 审计 / 解释

---

## 8. 关键约束（必须满足）

1. **当前输入优先于历史记忆**
2. **没有用户确认，不升格为强事实**
3. **历史记忆只能作为约束与参考**
4. **所有事实必须可追溯来源**
5. **任何记忆都必须可撤回**

---

## 9. 成功标准（你可以用来验收）

一个成功的个人 Agent 记忆系统应满足：

* 清空记忆后，Agent 仍然逻辑正确
* 引入记忆后，Agent 更贴合用户
* 用户能理解 Agent 为什么这么说
* 用户能纠正 Agent 对自己的“误解”

