# 个人 Agent 记忆系统可执行落地计划（Python + SurrealDB）

## 1. 计划目标

基于 `/Users/suntc/project/hippos/技术架构文档.md`，将系统拆分为可并行、可验收、可发布的功能模块，形成从 0 到可用版本（MVP）的执行路径。

## 2. 计划范围

1. 仅建设记忆系统，不包含对话生成系统。
2. 对外接口面向外部 Agent，个人版采用最小入参。
3. 统一使用 SurrealDB（文档 + 图 + 向量）。
4. 单 LLM（记忆 LLM）用于提议，不直接写库。

## 3. 里程碑与节奏（建议 4 周）

| 里程碑 | 周期 | 目标 | 出口标准 |
|---|---|---|---|
| M0 基础可运行 | 第 1 周 | 项目骨架、DDL、基础 API 可启动 | 本地 `docker compose up` 后 API 可健康检查 |
| M1 核心可用 | 第 2 周 | 事件写入 + 记忆查询 + 异步提议落库 | 能完成 `append -> query -> audit` 全链路 |
| M2 治理可控 | 第 3 周 | 裁决规则、事实覆盖撤回、TTL/衰减 | 支持 override/revoke，候选事实可过期 |
| M3 稳定可交付 | 第 4 周 | 观测、压测、回归用例、发布文档 | 达到 P95 指标并完成发布清单 |

## 4. 模块拆分总览

| 模块ID | 模块名称 | 依赖 | 并行性 | 主要交付物 |
|---|---|---|---|---|
| A | 项目骨架与工程化 | 无 | 可先行 | 目录、配置、启动脚本、Makefile |
| B | 数据层（SurrealDB） | A | 低 | DDL、初始化脚本、索引验证脚本 |
| C | API 层（Events/Query/Governance/Audit） | A,B | 中 | FastAPI 路由与 Pydantic 模型 |
| D | Repository 与查询编排 | B,C | 中 | SurrealDB 访问层、联合查询实现 |
| E | 记忆 LLM 适配器 | C | 高 | 提议 schema、LLM 调用封装 |
| F | 裁决引擎 Arbiter | D,E | 中 | 规则配置、评分器、动作执行 |
| G | 异步 Worker 任务 | D,E,F | 中 | 提议消费、TTL、衰减、冲突检测 |
| H | 治理与审计 | C,D,F | 高 | override/revoke/delete/audit 全链路 |
| I | 观测与质量保障 | A~H | 低 | 指标、日志、测试、压测报告 |
| J | 发布与运维文档 | A~I | 低 | 部署文档、Runbook、发布清单 |

## 5. 详细执行计划（按模块）

## A. 项目骨架与工程化

1. 任务清单
- [ ] 建立目录结构：`app/api app/core app/repository app/services app/workers tests scripts`
- [ ] 初始化依赖：FastAPI、Pydantic v2、SurrealDB client、Arq/Celery、OTel
- [ ] 提供 `.env.example` 与配置加载模块
- [ ] 增加 `Makefile`：`dev/test/lint/run-worker`
- [ ] 增加基础 CI（lint + unit tests）

2. 交付物
- `/Users/suntc/project/hippos/pyproject.toml`
- `/Users/suntc/project/hippos/Makefile`
- `/Users/suntc/project/hippos/app/main.py`

3. 验收标准（DoD）
- [ ] 本地可一键启动 API
- [ ] CI 可执行并通过

## B. 数据层（SurrealDB）

1. 任务清单
- [ ] 落地 DDL：`event_log/recall_chunk/fact_candidate/fact_truth/entity/relation/audit_log`
- [ ] 建立初始化脚本与迁移策略（版本号 + 幂等）
- [ ] 验证向量索引可用（HNSW）
- [ ] 建立基础数据校验脚本（字段与索引存在性）

2. 交付物
- `/Users/suntc/project/hippos/surrealdb_ddl.surql`
- `/Users/suntc/project/hippos/scripts/db_init.sh`
- `/Users/suntc/project/hippos/scripts/db_check.sh`

3. 验收标准（DoD）
- [ ] 新环境可自动建库建表
- [ ] 索引检查全部通过

## C. API 层（对外 Agent）

1. 任务清单
- [ ] 实现 `POST /api/v1/events.append`
- [ ] 实现 `POST /api/v1/events.batch_append`
- [ ] 实现 `POST /api/v1/memory.query`
- [ ] 实现 `GET /api/v1/memory.facts`
- [ ] 实现治理与审计接口
- [ ] 在中间件中注入默认身份：tenant/user/agent/session

2. 交付物
- `/Users/suntc/project/hippos/memory_openapi.yaml`
- `/Users/suntc/project/hippos/app/api/routes/*.py`
- `/Users/suntc/project/hippos/app/schemas/*.py`

3. 验收标准（DoD）
- [ ] 个人版最小入参可用（仅 `content` 与 `query_text`）
- [ ] OpenAPI 与实现字段一致

## D. Repository 与查询编排

1. 任务清单
- [ ] 封装事件写入与审计写入仓储方法
- [ ] 封装事实查询（按有效期、状态、scope）
- [ ] 封装向量召回（Top-K）
- [ ] 封装关系查询（1~2 跳）
- [ ] 封装联合查询聚合器（facts + recalls + relations）

2. 交付物
- `/Users/suntc/project/hippos/app/repository/surreal_repository.py`
- `/Users/suntc/project/hippos/app/services/query_service.py`

3. 验收标准（DoD）
- [ ] `memory.query` 返回结构化三层结果
- [ ] 空数据/异常路径有可预期响应

## E. 记忆 LLM 适配器

1. 任务清单
- [ ] 定义提议 JSON Schema（recall/fact_candidate/relation）
- [ ] 封装 LLM 调用与超时重试
- [ ] 对提议做 schema 校验和非法字段拒绝
- [ ] 记录提议摘要到审计轨迹

2. 交付物
- `/Users/suntc/project/hippos/app/services/memory_llm_adapter.py`
- `/Users/suntc/project/hippos/app/schemas/proposal.py`

3. 验收标准（DoD）
- [ ] 任意事件批次可生成合法提议对象
- [ ] 非法提议不入库且可审计

## F. 裁决引擎 Arbiter

1. 任务清单
- [ ] 实现硬约束校验（确认信号、来源证据、冲突判定）
- [ ] 实现评分器（确认强度、稳定性、一致性、风险）
- [ ] 实现动作路由（event-only / recall / candidate / promote）
- [ ] 规则配置化（YAML）与热加载

2. 交付物
- `/Users/suntc/project/hippos/app/services/arbiter_engine.py`
- `/Users/suntc/project/hippos/app/core/rules.yaml`

3. 验收标准（DoD）
- [ ] 同一输入在固定规则下结果可复现
- [ ] 每次裁决都有明确 reason code

## G. 异步 Worker 任务

1. 任务清单
- [ ] 事件入队与提议处理任务
- [ ] 候选事实 TTL 过期任务
- [ ] recall 衰减任务
- [ ] 冲突检测任务与降级动作

2. 交付物
- `/Users/suntc/project/hippos/app/workers/tasks.py`
- `/Users/suntc/project/hippos/app/workers/scheduler.py`

3. 验收标准（DoD）
- [ ] 事件写入后 10 秒内完成提议处理
- [ ] 过期任务可按计划稳定执行

## H. 治理与审计

1. 任务清单
- [ ] 实现事实覆盖（版本递增，旧版本状态更新）
- [ ] 实现事实撤回（revoked）
- [ ] 实现线索删除
- [ ] 实现 trace 维度审计查询

2. 交付物
- `/Users/suntc/project/hippos/app/services/governance_service.py`
- `/Users/suntc/project/hippos/app/services/audit_service.py`

3. 验收标准（DoD）
- [ ] `override/revoke/delete` 行为可回放
- [ ] `GET /memory.audit/{trace_id}` 可完整展示动作链

## I. 观测与质量保障

1. 任务清单
- [ ] 接入结构化日志（trace_id 全链路）
- [ ] 接入 OTel 指标与追踪
- [ ] 建立单元测试与集成测试
- [ ] 建立基础压测场景（append/query）

2. 交付物
- `/Users/suntc/project/hippos/tests/unit/*`
- `/Users/suntc/project/hippos/tests/integration/*`
- `/Users/suntc/project/hippos/reports/perf_report.md`

3. 验收标准（DoD）
- [ ] `events.append` P95 < 200ms（不含异步）
- [ ] `memory.query` P95 < 400ms

## J. 发布与运维文档

1. 任务清单
- [ ] 编写本地部署文档（Docker Compose）
- [ ] 编写生产部署文档（K8s 可选）
- [ ] 编写 Runbook（故障排查、回滚、数据修复）
- [ ] 形成版本发布清单与变更记录模板

2. 交付物
- `/Users/suntc/project/hippos/docs/deploy.md`
- `/Users/suntc/project/hippos/docs/runbook.md`
- `/Users/suntc/project/hippos/docs/release-checklist.md`

3. 验收标准（DoD）
- [ ] 新成员可按文档独立拉起系统
- [ ] 出现异常可按 Runbook 在 30 分钟内定位

## 6. 执行顺序与依赖策略

1. 串行主链：A -> B -> C -> D -> F -> H -> I -> J
2. 并行支线：E 与 D 并行；G 在 E+F 后进入
3. 每周固定一次里程碑评审，输出风险清单与下一周冻结范围

## 7. 风险清单与应对

1. 向量索引语法与 SurrealDB 版本不一致
- 应对：DDL 保留版本兼容注释；初始化脚本按版本分支执行。

2. LLM 提议质量波动
- 应对：先严格 schema 校验与硬约束，再逐步放宽阈值。

3. 查询延迟超标
- 应对：限制 top_k/hops 默认值；为热点事实增加缓存。

4. 治理操作导致事实错乱
- 应对：所有治理动作必须事务化并写审计。

## 8. 发布闸门（Go/No-Go）

1. 功能闸门
- [ ] 事件写入、联合查询、治理、审计全部可用

2. 质量闸门
- [ ] 核心链路集成测试通过
- [ ] 性能指标达到文档目标

3. 运维闸门
- [ ] 部署文档与回滚文档可执行
- [ ] 关键指标与告警生效

## 9. 首次执行建议（本周）

1. 先完成 A+B+C 的最小闭环并发布 `v0.1.0-alpha`
2. 用 20 条真实历史事件样本验证 E+F 规则效果
3. 在第 2 周末前完成 `append -> query -> audit` 端到端演示
