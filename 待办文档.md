Hippos é¡¹ç›®ä»£ç å®¡æŸ¥æŠ¥å‘Š
ä¸€ã€å‘ç°çš„é€»è¾‘æ¼æ´
| ä¸¥é‡æ€§ | ä½ç½® | é—®é¢˜æè¿° | å»ºè®®ä¿®å¤ |
|--------|------|----------|----------|
| ğŸ”´ é«˜ | turn_handler.rs:17-41 | create_turn åªéªŒè¯ session_idï¼Œä¸éªŒè¯ç§Ÿæˆ·å½’å±ã€‚ä»»ä½•ç”¨æˆ·å¯ä¸ºä»»ä½• session åˆ›å»º turnã€‚ | æ·»åŠ ç§Ÿæˆ·éš”ç¦»éªŒè¯ï¼šå…ˆé€šè¿‡ session_service.get_by_id è·å– sessionï¼Œæ£€æŸ¥ session.tenant_id == claims.tenant_id |
| ğŸ”´ é«˜ | search_handler.rs:25-153 | semantic_searchã€hybrid_searchã€get_recent_context éƒ½ä¸éªŒè¯ç§Ÿæˆ·ã€‚å¯æœç´¢å…¶ä»–ç§Ÿæˆ·çš„ä¼šè¯å†…å®¹ã€‚ | åœ¨æœç´¢å‰éªŒè¯ session æ˜¯å¦å±äºå½“å‰ç§Ÿæˆ· |
| ğŸ”´ é«˜ | session_handler.rs:158-196 | update_session å®Œå…¨ä¸éªŒè¯ç§Ÿæˆ·æƒé™ã€‚ç”¨æˆ·å¯ä¿®æ”¹å…¶ä»–ç§Ÿæˆ·çš„ sessionã€‚ | æ·»åŠ  if session.tenant_id != claims.tenant_id éªŒè¯ |
| ğŸ”´ é«˜ | session_handler.rs:198-216 | delete_session åŒæ ·ä¸éªŒè¯ç§Ÿæˆ·æƒé™ã€‚å¯åˆ é™¤å…¶ä»–ç§Ÿæˆ·çš„ä¼šè¯ã€‚ | æ·»åŠ ç§Ÿæˆ·éš”ç¦»éªŒè¯ |
| ğŸ”´ é«˜ | turn_handler.rs:104-133 | delete_turn ä¸éªŒè¯ç§Ÿæˆ·ã€‚å¯åˆ é™¤å…¶ä»–ç§Ÿæˆ·çš„ turnã€‚ | æ·»åŠ ç§Ÿæˆ·éš”ç¦»éªŒè¯ |
| ğŸ”´ é«˜ | turn_handler.rs:135-169 | update_turn ä¸éªŒè¯ç§Ÿæˆ·ã€‚å¯ä¿®æ”¹å…¶ä»–ç§Ÿæˆ·çš„ turn å†…å®¹ã€‚ | æ·»åŠ ç§Ÿæˆ·éš”ç¦»éªŒè¯ |
| ğŸ”´ é«˜ | session_handler.rs:218-254 | archive_session åªéªŒè¯è¯»æ“ä½œï¼Œä½†å½’æ¡£åæ— çŠ¶æ€æ£€æŸ¥ã€‚å¯é‡å¤å½’æ¡£å·²å½’æ¡£çš„ sessionã€‚ | æ·»åŠ  if session.status == SessionStatus::Archived çŠ¶æ€æ£€æŸ¥ |
| ğŸŸ¡ ä¸­ | repository.rs:191-204 | get_max_turn_number å­˜åœ¨ TOCTOU ç«æ€æ¡ä»¶ã€‚å¤šå¹¶å‘è¯·æ±‚å¯èƒ½å¾—åˆ°ç›¸åŒ turn_numberã€‚ | ä½¿ç”¨æ•°æ®åº“åŸå­æ“ä½œæˆ–åˆ†å¸ƒå¼é” |
| ğŸŸ¡ ä¸­ | session/mod.rs:182-189 | archive æ–¹æ³•ä¸éªŒè¯å½“å‰çŠ¶æ€ã€‚Archive â†’ Archived ä»ä¼šæ‰§è¡Œæ›´æ–°æ“ä½œã€‚ | æ·»åŠ  if session.status == SessionStatus::Archived æå‰è¿”å› |
| ğŸŸ¡ ä¸­ | session/mod.rs:191-201 | restore æ–¹æ³•ä¸æ£€æŸ¥çŠ¶æ€ã€‚ä» Deleted çŠ¶æ€æ¢å¤å¯èƒ½æœ‰é—®é¢˜ã€‚ | æ·»åŠ çŠ¶æ€å‰ç½®æ¡ä»¶æ£€æŸ¥ |
| ğŸŸ¡ ä¸­ | turn_handler.rs:43-80 | list_turns ç¼ºå°‘ç§Ÿæˆ·éªŒè¯ã€‚å¯åˆ—å‡ºå…¶ä»–ç§Ÿæˆ·çš„ turnã€‚ | æ·»åŠ ç§Ÿæˆ·éš”ç¦»éªŒè¯ |
| ğŸŸ¡ ä¸­ | session/mod.rs:256-293 | restore_session ç¼ºå°‘çŠ¶æ€éªŒè¯ï¼Œå¯ä»ä»»æ„çŠ¶æ€æ¢å¤ã€‚ | æ·»åŠ çŠ¶æ€å‰ç½®æ¡ä»¶æ£€æŸ¥ |
| ğŸŸ¢ ä½ | session/mod.rs:139-164 | delete æ–¹æ³•ä½¿ç”¨åˆ†é¡µåˆ é™¤ (limit=1000)ã€‚å¦‚æœ session æœ‰è¶…è¿‡ 1000 ä¸ª turnï¼Œå°†æ— æ³•å…¨éƒ¨åˆ é™¤ã€‚ | ä½¿ç”¨ while å¾ªç¯åˆ é™¤ç›´åˆ°æ²¡æœ‰æ›´å¤š turn |
äºŒã€æœªé—­ç¯é€»è¾‘
| ä¼˜å…ˆçº§ | æ¨¡å— | åŠŸèƒ½æè¿° | å½“å‰çŠ¶æ€ | å»ºè®® |
|--------|------|----------|----------|------|
| P0 | turn_handler.rs:104-133 | åˆ é™¤ turn æ—¶åªéªŒè¯ session_id åŒ¹é…ï¼Œä¸éªŒè¯ç§Ÿæˆ· | é€»è¾‘ä¸å®Œæ•´ | éœ€æ·»åŠ ç§Ÿæˆ·éš”ç¦»éªŒè¯ |
| P0 | search_handler.rs | æœç´¢æœåŠ¡å®Œå…¨ä¸éªŒè¯ç§Ÿæˆ· | é€»è¾‘ä¸å®Œæ•´ | éœ€æ·»åŠ å®Œæ•´çš„ç§Ÿæˆ·éš”ç¦»éªŒè¯ |
| P0 | session_handler.rs:158-216 | update/delete/archive/restore éƒ½ç¼ºå°‘å‰ç½®çŠ¶æ€éªŒè¯ | é€»è¾‘ä¸å®Œæ•´ | éœ€æ·»åŠ çŠ¶æ€æœºéªŒè¯ |
| P1 | turn/mod.rs:246-300 | identify_turn_groups ä½¿ç”¨ repository.list(1000, 0) å…¨å±€æŸ¥è¯¢ | é€»è¾‘ä¸å®Œæ•´ | åº”ä½¿ç”¨ list_by_session è¿‡æ»¤ |
| P1 | repository.rs:373-374 | IndexRecordRepository ç»§æ‰¿é»˜è®¤çš„ list_by_tenant å’Œ count_by_tenant | é€»è¾‘ä¸å®Œæ•´ | éœ€ä¸º IndexRecord æ·»åŠ ç§Ÿæˆ·éš”ç¦»å®ç° |
| P2 | index/mod.rs:164-214 | index_turn æ²¡æœ‰æ£€æµ‹ turn æ˜¯å¦å·²ç´¢å¼• | æœªé—­ç¯ | æ·»åŠ å»é‡æ£€æµ‹ |
| P2 | index/mod.rs:326-336 | delete_index åªè¿”å› vector_deleted \|\| fts_deleted | ä¸ç²¾ç¡® | åº”åˆ†åˆ«è¿”å›ä¸¤ä¸ªåˆ é™¤ç»“æœ |
ä¸‰ã€æœªå®ç°èƒ½åŠ›
| ä¼˜å…ˆçº§ | åŠŸèƒ½ | è®¾è®¡æ¥æº | å½“å‰çŠ¶æ€ |
|--------|------|----------|----------|
| P0 | å®Œæ•´çš„ç§Ÿæˆ·éš”ç¦»éªŒè¯ | å¤šç§Ÿæˆ·è®¾è®¡è¦æ±‚ | éƒ¨åˆ†å®ç°ï¼šSession CRUD æœ‰éªŒè¯ï¼ŒTurn å’Œ Search æ— éªŒè¯ |
| P0 | è®¤è¯ä¸­é—´ä»¶ä¿æŠ¤ | å®‰å…¨è®¾è®¡æ–‡æ¡£ | æœªåœ¨è·¯ç”±ä¸­å¯ç”¨ï¼šæ‰€æœ‰ç«¯ç‚¹éƒ½æš´éœ² |
| P0 | ä¼šè¯çŠ¶æ€æœºéªŒè¯ | SessionStatus æšä¸¾å®šä¹‰ | æœªå®ç°ï¼šæ‰€æœ‰çŠ¶æ€è½¬æ¢éƒ½å…è®¸ |
| P1 | åˆ†å¸ƒå¼é” | get_max_turn_number ç«æ€æ¡ä»¶è¯´æ˜ | æœªå®ç°ï¼šä½¿ç”¨å†…å­˜é”è€Œé Redis åˆ†å¸ƒå¼é” |
| P1 | ç´¢å¼•å»é‡ | index_turn æ–‡æ¡£æ³¨é‡Š | æœªå®ç°ï¼šé‡å¤ç´¢å¼•å°†è¦†ç›– |
| P1 | çº§è”åˆ é™¤ç¡®è®¤ | Session åˆ é™¤æ³¨é‡Š | æœªå®ç°ï¼šåªåˆ é™¤ 1000 ä¸ªï¼Œå¤šçš„ä¸åˆ  |
| P2 | ä¹è§‚é” | æ¶æ„è®¾è®¡ | æœªå®ç°ï¼šç›´æ¥è¦†ç›–æ›´æ–° |
| P2 | è‡ªåŠ¨æ‘˜è¦ç”Ÿæˆ | SessionConfig.auto_summarize | æœªå®ç°ï¼šé…ç½®å­˜åœ¨ä½†æ— è°ƒç”¨ä»£ç  |
| P2 | Token è®¡æ•° | TurnMetadata.token_count | æœªå®ç°ï¼šå§‹ç»ˆä¸º Noneï¼Œä½¿ç”¨ä¼°ç®—å€¼ |
å››ã€å®‰å…¨éšæ‚£
| ä¸¥é‡æ€§ | ç±»å‹ | ä½ç½® | æè¿° |
|--------|------|------|------|
| ğŸ”´ é«˜ | è®¤è¯ç»•è¿‡ | api/routes/*.rs | æ‰€æœ‰ API ç«¯ç‚¹éƒ½æ²¡æœ‰åº”ç”¨è®¤è¯ä¸­é—´ä»¶ï¼Œå¯åŒ¿åè®¿é—® |
| ğŸ”´ é«˜ | æƒé™æå‡ | middleware.rs:428-435 | é€Ÿç‡é™åˆ¶çš„å®¢æˆ·ç«¯ ID æå–ä¼˜å…ˆçº§é—®é¢˜ |
| ğŸŸ¡ ä¸­ | ä¿¡æ¯æ³„éœ² | middleware.rs:59-65 | è®¤è¯å¤±è´¥æ—¶å¯èƒ½è¿”å›è¯¦ç»†çš„ AppError |
| ğŸŸ¡ ä¸­ | CORS é…ç½® | middleware.rs:245-278 | CORS ä¸­é—´ä»¶å…è®¸ * é€šé…ç¬¦ |
| ğŸŸ¢ ä½ | é»˜è®¤å¯†é’¥ | auth.rs:195-201, 300-307 | ä½¿ç”¨ç¡¬ç¼–ç çš„é»˜è®¤å€¼ |
| ğŸŸ¢ ä½ | é€Ÿç‡é™åˆ¶ | middleware.rs:385-446 | é€Ÿç‡é™åˆ¶é»˜è®¤ç¦ç”¨ |
| ğŸŸ¢ ä½ | SQL æ³¨å…¥é˜²æŠ¤ | repository.rs | éƒ¨åˆ†æŸ¥è¯¢ä½¿ç”¨ format! æ‹¼æ¥ |
äº”ã€æ¶æ„é—®é¢˜
| ç±»å‹ | æè¿° | å½±å“ | å»ºè®® |
|------|------|------|------|
| å®‰å…¨ | è®¤è¯ä¸­é—´ä»¶æœªå¯ç”¨ | æ‰€æœ‰ API ç«¯ç‚¹å¯åŒ¿åè®¿é—® | åœ¨è·¯ç”±æ„å»ºæ—¶åº”ç”¨è®¤è¯ä¸­é—´ä»¶ |
| å®‰å…¨ | è·¯ç”±é…ç½®ä¸ä¸­é—´ä»¶åˆ†ç¦» | MiddlewareBuilder æœ‰ auth é…ç½®ï¼Œä½†è·¯ç”±æœªä½¿ç”¨ | ç»Ÿä¸€ä½¿ç”¨ MiddlewareBuilder æ„å»ºè·¯ç”± |
| æ€§èƒ½ | identify_turn_groups å…¨è¡¨æ‰«æ | O(n) æ—¶é—´å¤æ‚åº¦ | ä½¿ç”¨ list_by_session è¿‡æ»¤ |
| æ€§èƒ½ | å†…å­˜ç´¢å¼•æ— æŒä¹…åŒ– | æœåŠ¡é‡å¯åç´¢å¼•ä¸¢å¤± | å®ç°æŒä¹…åŒ–å­˜å‚¨ |
| è®¾è®¡ | Repository é»˜è®¤æ–¹æ³•ä¸å®‰å…¨ | list_by_tenant é»˜è®¤è¿”å›æ‰€æœ‰æ•°æ® | å°†é»˜è®¤æ–¹æ³•æ”¹ä¸º unimplemented!() |
| è®¾è®¡ | æ··åˆç´¢å¼•ä½¿ç”¨ | RRF Fusion å‚æ•° k=60 ç¡¬ç¼–ç  | æå–ä¸ºé…ç½®é¡¹ |
| ä¸€è‡´ | é”™è¯¯å¤„ç†é£æ ¼ä¸ç»Ÿä¸€ | æœ‰çš„è¿”å› AppError::NotFoundï¼Œæœ‰çš„è¿”å› 200 OK | ç»Ÿä¸€ä½¿ç”¨ HTTP çŠ¶æ€ç  |
å…­ã€å»ºè®®ä¼˜å…ˆçº§
ç´§æ€¥ä¿®å¤ (P0)
1. å¯ç”¨è®¤è¯ä¸­é—´ä»¶ â€” ä¿®æ”¹ api/mod.rs ä¸­çš„ create_router
2. ä¿®å¤ Turn Handler ç§Ÿæˆ·éš”ç¦» â€” åœ¨æ‰€æœ‰ turn æ“ä½œä¸­æ·»åŠ ç§Ÿæˆ·éªŒè¯
3. ä¿®å¤ Search Handler ç§Ÿæˆ·éš”ç¦» â€” åœ¨æœç´¢æ“ä½œä¸­æ·»åŠ ç§Ÿæˆ·éªŒè¯
4. ä¿®å¤ Session Handler æƒé™éªŒè¯ â€” åœ¨ update/delete ä¸­æ·»åŠ ç§Ÿæˆ·éš”ç¦»
5. æ·»åŠ çŠ¶æ€æœºéªŒè¯ â€” åœ¨ archiveã€restore æ–¹æ³•ä¸­æ·»åŠ çŠ¶æ€æ£€æŸ¥
è¿‘æœŸä¼˜åŒ– (P1)
1. ä¿®å¤ç«æ€æ¡ä»¶ â€” å¯¹ get_max_turn_number ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
2. å®ç°å®Œæ•´çš„çº§è”åˆ é™¤ â€” ä½¿ç”¨å¾ªç¯åˆ é™¤ç›´åˆ°æ‰€æœ‰ turn è¢«åˆ é™¤
3. ä¿®å¤ identify_turn_groups â€” ä½¿ç”¨ list_by_session æ›¿ä»£å…¨å±€ list
4. æ·»åŠ ç´¢å¼•å»é‡æ£€æµ‹ â€” åœ¨ index_turn ä¸­æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç´¢å¼•
5. ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼ â€” ç¡®ä¿æ‰€æœ‰é”™è¯¯è¿”å›ä¸€è‡´çš„ JSON æ ¼å¼
é•¿æœŸæ”¹è¿› (P2)
1. å®ç°æŒä¹…åŒ–ç´¢å¼• â€” å°†å‘é‡ç´¢å¼•å’Œå…¨æ–‡ç´¢å¼•æŒä¹…åŒ–åˆ°ç£ç›˜
2. æ·»åŠ ä¹è§‚é”æœºåˆ¶ â€” åœ¨æ›´æ–°æ“ä½œä¸­ä½¿ç”¨ç‰ˆæœ¬å·é˜²æ­¢å¹¶å‘å†²çª
3. å®ç°è‡ªåŠ¨æ‘˜è¦ â€” æ ¹æ® auto_summarize é…ç½®è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦
4. æ·»åŠ  Redis åˆ†å¸ƒå¼é” â€” æ”¯æŒé«˜å¹¶å‘åœºæ™¯
5. å®Œå–„æµ‹è¯•è¦†ç›– â€” æ·»åŠ ç§Ÿæˆ·éš”ç¦»ã€å¹¶å‘å®‰å…¨ã€çŠ¶æ€è½¬æ¢çš„æµ‹è¯•ç”¨ä¾‹